<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth Studio</title>
    <meta name="description" content="A single-screen photobooth application with camera, gallery, and collage features.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }
        
        h1, h2, h3, h4, button {
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .container-height {
            height: calc(100vh - 2rem);
            max-height: calc(100vh - 2rem);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }
        
        .tab-button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 3px;
            background: #667eea;
            border-radius: 2px;
        }
        
        .camera-container {
            aspect-ratio: 4/3;
            max-height: 55vh;
        }
        
        .capture-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: white;
            border: 4px solid #667eea;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .capture-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }
        
        .capture-button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
        }
        
        .filter-chip {
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .filter-chip.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .gallery-grid {
            height: 50vh;
            overflow-y: auto;
            padding-right: 4px;
        }
        
        .gallery-grid::-webkit-scrollbar {
            width: 4px;
        }
        
        .gallery-grid::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }
        
        .gallery-grid::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 10px;
        }
        
        .photo-item {
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .photo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .photo-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .photo-item:hover .photo-actions {
            opacity: 1;
        }
        
        .collage-templates {
            height: 50vh;
            overflow-y: auto;
        }
        
        .template-item {
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-item:hover {
            border-color: #667eea;
            transform: scale(1.02);
        }
        
        .template-item.active {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }
        
        .countdown-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .countdown-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            opacity: 0;
            z-index: 100;
            pointer-events: none;
        }
        
        .flash {
            animation: flash 0.3s ease-out;
        }
        
        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }
        
        .selected-overlay {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        
        .tab-content {
            display: none;
            height: 100%;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <!-- Hidden Canvas -->
    <canvas id="photoCanvas" style="display: none;"></canvas>
    
    <!-- Flash Effect -->
    <div id="flashEffect" class="flash-effect"></div>
    
    <!-- Main Container -->
    <div class="w-full max-w-6xl container-height">
        <div class="glass-card rounded-3xl h-full p-6 flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent">
                        Photobooth Studio
                    </h1>
                    <p class="text-gray-600 text-sm">Capture • Edit • Create</p>
                </div>
                <div class="flex gap-2">
                    <button id="downloadAll" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium transition">
                        <span class="hidden sm:inline">Export All</span>
                        <svg class="w-5 h-5 sm:ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                    </button>
                    <button id="clearAll" class="px-4 py-2 rounded-full bg-red-50 hover:bg-red-100 text-red-600 text-sm font-medium transition">
                        <span class="hidden sm:inline">Clear All</span>
                        <svg class="w-5 h-5 sm:ml-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex gap-2 mb-6 bg-gray-100 rounded-2xl p-1">
                <button class="tab-button flex-1 py-3 rounded-xl text-center font-medium text-gray-600 active" data-tab="camera">
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        <span>Camera</span>
                    </div>
                </button>
                <button class="tab-button flex-1 py-3 rounded-xl text-center font-medium text-gray-600" data-tab="gallery">
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span>Gallery</span>
                    </div>
                </button>
                <button class="tab-button flex-1 py-3 rounded-xl text-center font-medium text-gray-600" data-tab="collage">
                    <div class="flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1H5a1 1 0 01-1-1v-3zM14 16a1 1 0 011-1h4a1 1 0 011 1v3a1 1 0 01-1 1h-4a1 1 0 01-1-1v-3z"/>
                        </svg>
                        <span>Collage</span>
                    </div>
                </button>
            </div>
            
            <!-- Tab Content -->
            <div class="flex-1 overflow-hidden">
                <!-- Camera Tab -->
                <div id="cameraTab" class="tab-content active h-full flex flex-col">
                    <!-- Camera Preview -->
                    <div class="camera-container rounded-2xl overflow-hidden bg-gray-900 mb-4 relative">
                        <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                        
                        <!-- Countdown Overlay -->
                        <div id="countdownOverlay" class="countdown-overlay hidden">
                            <div class="countdown-circle">
                                <span id="countdownText" class="text-white text-6xl font-bold">3</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Camera Controls -->
                    <div class="flex-1 flex flex-col">
                        <!-- Filters -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-700 mb-2">Filters</p>
                            <div class="flex gap-2 overflow-x-auto pb-2">
                                <button class="filter-chip active" data-filter="none">Original</button>
                                <button class="filter-chip" data-filter="bw">Black & White</button>
                                <button class="filter-chip" data-filter="vintage">Vintage</button>
                                <button class="filter-chip" data-filter="vibrant">Vibrant</button>
                                <button class="filter-chip" data-filter="warm">Warm</button>
                                <button class="filter-chip" data-filter="cool">Cool</button>
                            </div>
                        </div>
                        
                        <!-- Timer & Settings -->
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-2">Timer</p>
                                <div class="flex gap-2">
                                    <button class="filter-chip active" data-timer="0">Off</button>
                                    <button class="filter-chip" data-timer="3">3s</button>
                                    <button class="filter-chip" data-timer="5">5s</button>
                                    <button class="filter-chip" data-timer="10">10s</button>
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-2">Settings</p>
                                <div class="flex gap-2">
                                    <button id="mirrorToggle" class="filter-chip active" data-setting="mirror">
                                        Mirror
                                    </button>
                                    <button id="gridToggle" class="filter-chip" data-setting="grid">
                                        Grid
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Capture Button -->
                        <div class="flex-1 flex items-center justify-center">
                            <div class="capture-button" id="captureButton"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Gallery Tab -->
                <div id="galleryTab" class="tab-content h-full">
                    <div class="h-full flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">
                                Your Photos <span id="photoCount" class="text-gray-500 font-normal">(0)</span>
                            </h3>
                            <button id="selectAll" class="px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm font-medium transition">
                                Select All
                            </button>
                        </div>
                        
                        <div id="galleryGrid" class="gallery-grid">
                            <div id="emptyGallery" class="empty-state">
                                <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <p class="text-gray-600 mb-2">No photos yet</p>
                                <p class="text-gray-500 text-sm">Switch to Camera tab to start capturing</p>
                            </div>
                        </div>
                        
                        <div class="flex gap-2 mt-4">
                            <button id="downloadSelected" class="flex-1 py-3 rounded-xl bg-gray-800 hover:bg-gray-900 text-white font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Download Selected
                            </button>
                            <button id="deleteSelected" class="flex-1 py-3 rounded-xl bg-red-100 hover:bg-red-200 text-red-600 font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Delete Selected
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Collage Tab -->
                <div id="collageTab" class="tab-content h-full">
                    <div class="h-full flex flex-col">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Create Collage</h3>
                        
                        <!-- Template Selection -->
                        <div class="mb-4">
                            <p class="text-sm font-medium text-gray-700 mb-2">Choose Template</p>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3 mb-6">
                                <div class="template-item active" data-template="2x2">
                                    <div class="grid grid-cols-2 gap-1 h-32 bg-gray-100 rounded-lg p-2">
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                    </div>
                                    <p class="text-center text-xs mt-2">2×2 Grid</p>
                                </div>
                                <div class="template-item" data-template="3vertical">
                                    <div class="grid grid-cols-3 gap-1 h-32 bg-gray-100 rounded-lg p-2">
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                    </div>
                                    <p class="text-center text-xs mt-2">3 Vertical</p>
                                </div>
                                <div class="template-item" data-template="bigsmall">
                                    <div class="grid grid-cols-2 gap-1 h-32 bg-gray-100 rounded-lg p-2">
                                        <div class="bg-gray-300 rounded col-span-2"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                        <div class="bg-gray-300 rounded"></div>
                                    </div>
                                    <p class="text-center text-xs mt-2">Big + Small</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Photo Selection -->
                        <div class="mb-4 flex-1">
                            <p class="text-sm font-medium text-gray-700 mb-2">
                                Select Photos <span id="selectedCount" class="text-gray-500">(0/4)</span>
                            </p>
                            <div id="collageGrid" class="collage-templates grid grid-cols-2 md:grid-cols-4 gap-3">
                                <!-- Photos will be dynamically added -->
                            </div>
                        </div>
                        
                        <!-- Collage Actions -->
                        <div class="flex gap-2">
                            <button id="createCollage" class="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 hover:opacity-90 text-white font-medium transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Create Collage
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Global State
        let stream = null;
        let photos = JSON.parse(localStorage.getItem('photobooth_photos') || '[]');
        let selectedPhotos = new Set();
        let collagePhotos = [];
        let currentFilter = 'none';
        let currentTimer = 0;
        let mirrorEnabled = true;
        let gridEnabled = false;
        let currentTab = 'camera';
        let selectedTemplate = '2x2';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updatePhotoCount();
            updateGallery();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Tab Navigation
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    switchTab(tab);
                });
            });
            
            // Camera Controls
            document.querySelectorAll('.filter-chip[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip[data-filter]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                });
            });
            
            document.querySelectorAll('.filter-chip[data-timer]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip[data-timer]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentTimer = parseInt(btn.dataset.timer);
                });
            });
            
            document.getElementById('mirrorToggle').addEventListener('click', toggleMirror);
            document.getElementById('gridToggle').addEventListener('click', toggleGrid);
            
            // Capture Button
            document.getElementById('captureButton').addEventListener('click', capturePhoto);
            
            // Gallery Actions
            document.getElementById('selectAll').addEventListener('click', selectAllPhotos);
            document.getElementById('downloadSelected').addEventListener('click', downloadSelectedPhotos);
            document.getElementById('deleteSelected').addEventListener('click', deleteSelectedPhotos);
            
            // Collage Actions
            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.template-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    selectedTemplate = item.dataset.template;
                });
            });
            
            document.getElementById('createCollage').addEventListener('click', createCollage);
            
            // Header Actions
            document.getElementById('downloadAll').addEventListener('click', downloadAllPhotos);
            document.getElementById('clearAll').addEventListener('click', clearAllPhotos);
            
            // Request camera permission on camera tab
            document.getElementById('cameraTab').addEventListener('click', () => {
                if (!stream && currentTab === 'camera') {
                    startCamera();
                }
            });
        }
        
        function switchTab(tab) {
            // Update active tab button
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                }
            });
            
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tab + 'Tab').classList.add('active');
            currentTab = tab;
            
            // Start camera if switching to camera tab
            if (tab === 'camera' && !stream) {
                startCamera();
            }
            
            // Update gallery if switching to gallery/collage
            if (tab === 'gallery') {
                updateGallery();
            }
            if (tab === 'collage') {
                updateCollageGrid();
            }
        }
        
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'user' }, 
                    audio: false 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.transform = mirrorEnabled ? 'scaleX(-1)' : 'scaleX(1)';
            } catch (err) {
                alert('Camera access denied. Please allow camera permissions.');
            }
        }
        
        function toggleMirror() {
            mirrorEnabled = !mirrorEnabled;
            const btn = document.getElementById('mirrorToggle');
            const video = document.getElementById('video');
            
            video.style.transform = mirrorEnabled ? 'scaleX(-1)' : 'scaleX(1)';
            btn.classList.toggle('active');
            btn.textContent = mirrorEnabled ? 'Mirror On' : 'Mirror Off';
        }
        
        function toggleGrid() {
            gridEnabled = !gridEnabled;
            const btn = document.getElementById('gridToggle');
            const cameraContainer = document.querySelector('.camera-container');
            
            if (gridEnabled) {
                cameraContainer.style.backgroundImage = `
                    linear-gradient(rgba(102, 126, 234, 0.1) 1px, transparent 1px),
                    linear-gradient(90deg, rgba(102, 126, 234, 0.1) 1px, transparent 1px)
                `;
                cameraContainer.style.backgroundSize = '20px 20px';
            } else {
                cameraContainer.style.backgroundImage = 'none';
            }
            
            btn.classList.toggle('active');
            btn.textContent = gridEnabled ? 'Grid On' : 'Grid Off';
        }
        
        function capturePhoto() {
            if (currentTimer > 0) {
                startCountdown();
            } else {
                takePhoto();
            }
        }
        
        function startCountdown() {
            const countdownEl = document.getElementById('countdownOverlay');
            const countdownText = document.getElementById('countdownText');
            let count = currentTimer;
            
            countdownEl.classList.remove('hidden');
            countdownText.textContent = count;
            
            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownText.textContent = count;
                } else {
                    clearInterval(interval);
                    countdownEl.classList.add('hidden');
                    takePhoto();
                }
            }, 1000);
        }
        
        function takePhoto() {
            if (!stream) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            if (mirrorEnabled) {
                ctx.scale(-1, 1);
                ctx.drawImage(canvas, -canvas.width, 0);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
            }
            
            applyFilter(ctx, canvas.width, canvas.height);
            
            const photoData = canvas.toDataURL('image/png');
            const photoId = Date.now();
            photos.push({ 
                id: photoId, 
                data: photoData, 
                timestamp: new Date().toISOString(),
                filter: currentFilter 
            });
            
            localStorage.setItem('photobooth_photos', JSON.stringify(photos));
            updatePhotoCount();
            
            if (currentTab === 'gallery') {
                updateGallery();
            }
            if (currentTab === 'collage') {
                updateCollageGrid();
            }
            
            flashEffect();
        }
        
        function applyFilter(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            switch(currentFilter) {
                case 'bw':
                    for (let i = 0; i < data.length; i += 4) {
                        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                        data[i] = avg;
                        data[i + 1] = avg;
                        data[i + 2] = avg;
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] + 40);
                        data[i + 1] = Math.min(255, data[i + 1] + 20);
                        data[i + 2] = Math.max(0, data[i + 2] - 20);
                    }
                    break;
                case 'vibrant':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.3);
                        data[i + 1] = Math.min(255, data[i + 1] * 1.3);
                        data[i + 2] = Math.min(255, data[i + 2] * 1.3);
                    }
                    break;
                case 'warm':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * 1.2);
                        data[i + 1] = Math.min(255, data[i + 1] * 1.1);
                    }
                    break;
                case 'cool':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i + 2] = Math.min(255, data[i + 2] * 1.2);
                    }
                    break;
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        function flashEffect() {
            const flash = document.getElementById('flashEffect');
            flash.classList.remove('flash');
            void flash.offsetWidth; // Trigger reflow
            flash.classList.add('flash');
        }
        
        function updatePhotoCount() {
            document.getElementById('photoCount').textContent = `(${photos.length})`;
        }
        
        function updateGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            const emptyGallery = document.getElementById('emptyGallery');
            
            if (photos.length === 0) {
                emptyGallery.classList.remove('hidden');
                galleryGrid.innerHTML = '';
                galleryGrid.appendChild(emptyGallery);
            } else {
                emptyGallery.classList.add('hidden');
                galleryGrid.innerHTML = '';
                
                photos.forEach((photo, index) => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.data}" class="w-full h-32 object-cover rounded-lg">
                        ${selectedPhotos.has(photo.id) ? 
                            `<div class="selected-overlay">${Array.from(selectedPhotos).indexOf(photo.id) + 1}</div>` : 
                            ''}
                        <div class="photo-actions">
                            <button onclick="togglePhotoSelection(${photo.id}, event)" class="w-8 h-8 rounded-full bg-white hover:bg-gray-100 flex items-center justify-center shadow">
                                <svg class="w-4 h-4 ${selectedPhotos.has(photo.id) ? 'text-purple-600' : 'text-gray-600'}" fill="${selectedPhotos.has(photo.id) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    galleryGrid.appendChild(photoItem);
                });
            }
            
            updateGalleryButtons();
        }
        
        function togglePhotoSelection(photoId, event) {
            event.stopPropagation();
            
            if (selectedPhotos.has(photoId)) {
                selectedPhotos.delete(photoId);
            } else {
                selectedPhotos.add(photoId);
            }
            
            updateGallery();
        }
        
        function selectAllPhotos() {
            if (selectedPhotos.size === photos.length) {
                selectedPhotos.clear();
            } else {
                photos.forEach(photo => selectedPhotos.add(photo.id));
            }
            updateGallery();
        }
        
        function updateGalleryButtons() {
            const hasSelected = selectedPhotos.size > 0;
            document.getElementById('downloadSelected').disabled = !hasSelected;
            document.getElementById('deleteSelected').disabled = !hasSelected;
            document.getElementById('selectAll').textContent = 
                selectedPhotos.size === photos.length ? 'Deselect All' : 'Select All';
        }
        
        function downloadSelectedPhotos() {
            selectedPhotos.forEach(photoId => {
                const photo = photos.find(p => p.id === photoId);
                const link = document.createElement('a');
                link.href = photo.data;
                link.download = `photo-${photoId}.png`;
                link.click();
            });
        }
        
        function deleteSelectedPhotos() {
            if (confirm(`Delete ${selectedPhotos.size} selected photo(s)?`)) {
                photos = photos.filter(photo => !selectedPhotos.has(photo.id));
                selectedPhotos.clear();
                localStorage.setItem('photobooth_photos', JSON.stringify(photos));
                updatePhotoCount();
                updateGallery();
            }
        }
        
        function downloadAllPhotos() {
            photos.forEach(photo => {
                const link = document.createElement('a');
                link.href = photo.data;
                link.download = `photo-${photo.id}.png`;
                link.click();
            });
        }
        
        function clearAllPhotos() {
            if (photos.length === 0) return;
            
            if (confirm(`Delete all ${photos.length} photos?`)) {
                photos = [];
                selectedPhotos.clear();
                localStorage.setItem('photobooth_photos', JSON.stringify(photos));
                updatePhotoCount();
                updateGallery();
                updateCollageGrid();
            }
        }
        
        function updateCollageGrid() {
            const collageGrid = document.getElementById('collageGrid');
            collageGrid.innerHTML = '';
            
            if (photos.length === 0) {
                collageGrid.innerHTML = `
                    <div class="col-span-4 empty-state h-64">
                        <p class="text-gray-600 mb-2">No photos yet</p>
                        <p class="text-gray-500 text-sm">Capture some photos first</p>
                    </div>
                `;
                return;
            }
            
            photos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item relative';
                photoItem.innerHTML = `
                    <img src="${photo.data}" class="w-full h-32 object-cover rounded-lg cursor-pointer" 
                         onclick="toggleCollagePhoto(${photo.id})">
                    ${collagePhotos.includes(photo.id) ? 
                        `<div class="selected-overlay">${collagePhotos.indexOf(photo.id) + 1}</div>` : 
                        ''}
                `;
                collageGrid.appendChild(photoItem);
            });
            
            updateCollageButton();
        }
        
        function toggleCollagePhoto(photoId) {
            if (collagePhotos.includes(photoId)) {
                collagePhotos = collagePhotos.filter(id => id !== photoId);
            } else {
                const templateRequirements = {
                    '2x2': 4,
                    '3vertical': 3,
                    'bigsmall': 3
                };
                
                if (collagePhotos.length >= templateRequirements[selectedTemplate]) {
                    collagePhotos.shift();
                }
                collagePhotos.push(photoId);
            }
            
            updateCollageGrid();
            document.getElementById('selectedCount').textContent = 
                `(${collagePhotos.length}/${getTemplateRequirement()})`;
        }
        
        function getTemplateRequirement() {
            const requirements = {
                '2x2': 4,
                '3vertical': 3,
                'bigsmall': 3
            };
            return requirements[selectedTemplate] || 4;
        }
        
        function updateCollageButton() {
            const requirement = getTemplateRequirement();
            const btn = document.getElementById('createCollage');
            btn.disabled = collagePhotos.length !== requirement;
        }
        
        function createCollage() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const layouts = {
                '2x2': { cols: 2, rows: 2, spacing: 20 },
                '3vertical': { cols: 3, rows: 1, spacing: 15 },
                'bigsmall': { cols: 2, rows: 2, spacing: 15 }
            };
            
            const layout = layouts[selectedTemplate];
            const spacing = layout.spacing;
            const totalWidth = 1200;
            const totalHeight = 800;
            canvas.width = totalWidth;
            canvas.height = totalHeight;
            
            // Background
            const gradient = ctx.createLinearGradient(0, 0, totalWidth, totalHeight);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, totalWidth, totalHeight);
            
            let loaded = 0;
            collagePhotos.forEach((photoId, index) => {
                const photo = photos.find(p => p.id === photoId);
                const img = new Image();
                img.src = photo.data;
                img.onload = () => {
                    let x, y, width, height;
                    
                    switch(selectedTemplate) {
                        case '2x2':
                            const col2 = index % 2;
                            const row2 = Math.floor(index / 2);
                            width = (totalWidth - spacing * 3) / 2;
                            height = (totalHeight - spacing * 3) / 2;
                            x = spacing + col2 * (width + spacing);
                            y = spacing + row2 * (height + spacing);
                            break;
                        case '3vertical':
                            width = (totalWidth - spacing * 4) / 3;
                            height = totalHeight - spacing * 2;
                            x = spacing + index * (width + spacing);
                            y = spacing;
                            break;
                        case 'bigsmall':
                            if (index === 0) {
                                width = (totalWidth - spacing * 3) / 2 * 2;
                                height = (totalHeight - spacing * 3) / 2;
                                x = spacing;
                                y = spacing;
                            } else {
                                width = (totalWidth - spacing * 3) / 2;
                                height = (totalHeight - spacing * 3) / 2;
                                x = spacing + (index - 1) * (width + spacing);
                                y = spacing * 2 + height;
                            }
                            break;
                    }
                    
                    // Draw with rounded corners
                    ctx.save();
                    ctx.beginPath();
                    ctx.roundRect(x, y, width, height, 20);
                    ctx.clip();
                    ctx.drawImage(img, x, y, width, height);
                    ctx.restore();
                    
                    // Border
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x, y, width, height);
                    
                    loaded++;
                    if (loaded === collagePhotos.length) {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL('image/png');
                        link.download = `collage-${Date.now()}.png`;
                        link.click();
                    }
                };
            });
        }
        
        // Initialize camera on load
        startCamera();
    </script>
</body>
</html>